
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="The extended tutorial builds on the basic tutorial, using an additional set of stages to flatten delimited data, perform some minor data transformations, and write to Elasticsearch. If you don't use ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Extended Tutorial"></meta><meta name="abstract" content="The extended tutorial builds on the basic tutorial, using an additional set of stages to flatten delimited data, perform some minor data transformations, and write to Elasticsearch."></meta><meta name="description" content="The extended tutorial builds on the basic tutorial, using an additional set of stages to flatten delimited data, perform some minor data transformations, and write to Elasticsearch."></meta><meta name="DC.Relation" scheme="URI" content="../Tutorial/Tutorial-title.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_w4n_gjt_ls"></meta><link rel="stylesheet" type="text/css" href="../oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Extended Tutorial</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="../oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="../skin.css"></link><script type="text/javascript"><!--
          
          var prefix = "../index.html";
          
          --></script><script type="text/javascript" src="../oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="../oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="../oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="../oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="../oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="../Tutorial/Tutorial-title.html" title="Data Collector Tutorial">Data Collector Tutorial</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="../Tutorial/Tutorial-title.html" title="Data Collector Tutorial"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Data Collector Tutorial</span></a></span>  </div></td></tr></tbody></table>
<div class="nested0" id="concept_w4n_gjt_ls">
 <h1 class="title topictitle1">Extended Tutorial</h1>

 
 <div class="body conbody"><p class="shortdesc">The extended tutorial builds on the basic tutorial, using an additional set of stages to
    flatten delimited data, perform some minor data transformations, and write to
    Elasticsearch.</p>

  <p class="p">If you don't use Elasticsearch, you can use data preview to see how the pipeline transforms
      data before we add the destination.</p>

    <div class="p">The extended tutorial continues with the following steps:<ol class="ol" id="concept_w4n_gjt_ls__ol_m23_hhk_ps">
        <li class="li">Use a Jython Evaluator to flatten data.</li>

        <li class="li">Configure a Field Converter to convert field types.</li>

        <li class="li">Manipulate data with the Expression Evaluator.</li>

        <li class="li">Use data preview to review and edit the pipeline.</li>

        <li class="li">Optionally connect an Elasticsearch destination and start the pipeline.</li>

      </ol>
</div>

 </div>

<div class="related-links"></div>
<div class="topic task nested1" id="task_cn5_w3k_ps">
    <h2 class="title topictitle2">Flatten Data with a Jython Evaluator</h2>

    
    <div class="body taskbody"><p class="shortdesc">To flatten data from the delimited data record format, let's use a Jython script with
        the Jython Evaluator.</p>

        <div class="section context">
            <p class="p">Flattening the delimited data converts the data from list format to a single level.
                After flattening the records, you no longer need to use delimited functions to
                return field data, or use an index in the field path. </p>

            <p class="p">For example, before flattening, we used the following field path to reference the
                field with credit card numbers: <samp class="ph codeph">[20]/value</samp>. After flattening, you
                use the following field path: <samp class="ph codeph">/credit_card.</samp></p>

        </div>

        <ol class="ol steps" id="task_cn5_w3k_ps__steps_s4j_x3k_ps"><li class="li step stepexpand">
                <span class="ph cmd">In the stage library, select the <span class="ph uicontrol">Jython Evaluator</span> and
                    connect the Field Masker and the Expression Evaluator to the stage, as
                    shown:</span>
                <div class="itemgroup info"><img class="image" id="task_cn5_w3k_ps__image_fsy_3nk_ps" src="../Graphics/Tutorial-Jython2pipeline.png" height="145" width="593"></img></div>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">On the <span class="ph uicontrol">Jython</span> tab, delete everything in the
                        <span class="ph uicontrol">Script</span> field and enter the following script:</span>
                <div class="itemgroup info">
                    <pre class="pre codeblock">try:
  for record in records:
    flattened = dict((field['header'].strip(), field['value'] if field['value'] != '' else None) for field in record.value)
    record.value = flattened
    out.write(record)
except Exception as e:
  err.write(record, e.message)  </pre>

                    <div class="note note"><span class="notetitle">Note:</span> Incorrect indentation can cause
                  Jython validation errors. For best results, copy the script from the online help.
                  Copying the script from the User Guide PDF can cause incorrect indentation. </div>

                </div>
            </li>
</ol>

    </div>

</div>
<div class="topic task nested1" id="task_kxl_tvk_ps">
    <h2 class="title topictitle2">Convert Types with a Field Converter</h2>

    
    <div class="body taskbody"><p class="shortdesc">Now that data is flattened, you can use a Field Converter to convert the data types
        of the flattened fields. Let's convert the appropriate fields to Datetime and Double. Any
        field that you don't convert remains a String field. </p>

        <div class="section context"></div>

        <ol class="ol steps" id="task_kxl_tvk_ps__steps_wx1_xvk_ps"><li class="li step stepexpand">
                <span class="ph cmd">From the stage library, select the <span class="ph uicontrol">Field Converter</span>
                    processor and connect it to the Jython Evaluator. Or, from the Pipeline Creation
                    Help Bar, click <span class="ph menucascade"><span class="ph uicontrol">Select Processor to Connect</span> &gt; <span class="ph uicontrol">Field Converter</span></span>.</span>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">Click the <span class="ph uicontrol">Conversions</span> tab.</span>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">Convert fields with datetime data to Datetime as follows:</span>
                <div class="itemgroup info">
                    
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="task_kxl_tvk_ps__table_h3v_yhz_ps" class="table" frame="border" border="1" rules="all">
                            
                            
                            <thead class="thead" align="left">
                                <tr class="row">
                                    <th class="entry" valign="top" id="d48979e178">Field Converter Property</th>

                                    <th class="entry" valign="top" id="d48979e181">Datetime Conversion</th>

                                </tr>

                            </thead>

                            <tbody class="tbody">
                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e178 ">Fields to Convert</td>

                                    <td class="entry" valign="top" headers="d48979e181 ">Click in the field and select the following fields:<ul class="ul" id="task_kxl_tvk_ps__ul_v3g_23z_ps">
                                            <li class="li">/dropoff_datetime</li>

                                            <li class="li">/pickup_datetime</li>

                                        </ul>
</td>

                                </tr>

                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e178 ">Convert to Type</td>

                                    <td class="entry" valign="top" headers="d48979e181 ">Datetime</td>

                                </tr>

                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e178 ">Date Format</td>

                                    <td class="entry" valign="top" headers="d48979e181 ">Select a format that you like.</td>

                                </tr>

                            </tbody>

                        </table>
</div>

                </div>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">To convert fields to Double, click the <span class="ph uicontrol">Add</span> icon and
                    configure the properties as follows:</span>
                <div class="itemgroup info">
                    
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="task_kxl_tvk_ps__table_xkg_g3z_ps" class="table" frame="border" border="1" rules="all">
                            
                            
                            <thead class="thead" align="left">
                                <tr class="row">
                                    <th class="entry" valign="top" id="d48979e250">Field Converter Property</th>

                                    <th class="entry" valign="top" id="d48979e253">Double Conversion</th>

                                </tr>

                            </thead>

                            <tbody class="tbody">
                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e250 ">Fields to Convert</td>

                                    <td class="entry" valign="top" headers="d48979e253 ">Click in the field and select the following fields:<ul class="ul" id="task_kxl_tvk_ps__ul_tlc_33z_ps">
                                            <li class="li">/fare_amount</li>

                                            <li class="li">/mta_tax</li>

                                            <li class="li">/pickup_latitude</li>

                                            <li class="li">/pickup_longitude</li>

                                            <li class="li">/surcharge</li>

                                            <li class="li">/tip_amount</li>

                                            <li class="li">/tolls_amount</li>

                                            <li class="li">/total_amount</li>

                                        </ul>
</td>

                                </tr>

                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e250 ">Convert to Type</td>

                                    <td class="entry" valign="top" headers="d48979e253 ">Double</td>

                                </tr>

                            </tbody>

                        </table>
</div>

                </div>
            </li>
</ol>

        <div class="section result">The pipeline and Field Converter should look like this:<p class="p"><img class="image" id="task_kxl_tvk_ps__image_lhs_bjq_ps" src="../Graphics/Tutorial-FieldConverter.png" height="360" width="762"></img></p>
</div>

    </div>

</div>
<div class="topic task nested1" id="task_rlk_tdq_ps">
    <h2 class="title topictitle2">Manipulate Data with the Expression Evaluator</h2>

    
    <div class="body taskbody"><p class="shortdesc">Before writing data to Elasticsearch, let's use an Expression Evaluator to merge the
        longitude and latitude information into a single pickup location field. </p>

        <div class="section context">We'll also calculate a total fare without the tip to get the basic trip revenue. </div>

        <ol class="ol steps" id="task_rlk_tdq_ps__steps_dzt_j3q_ps"><li class="li step stepexpand">
                <span class="ph cmd">Add an <span class="ph uicontrol">Expression Evaluator</span> to the canvas and connect it
                    to the <span class="ph uicontrol">Field Converter</span>.</span>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">On the <span class="ph uicontrol">Expressions</span> tab, enter the following information
                    to generate pickup location data:</span>
                <div class="itemgroup info">
                    <ul class="ul" id="task_rlk_tdq_ps__ul_bfl_y2y_ps">
                        <li class="li">For the <span class="ph uicontrol">Output Field</span> property, enter
                            "/pickup_location".</li>

                        <li class="li">For <span class="ph uicontrol">Expression</span> property, enter the following expression:<pre class="pre codeblock">${record:value('/pickup_latitude')}, ${record:value('/pickup_longitude')}</pre>

                            <p class="p">This returns the data from the two flattened fields in the following
                                format: &lt;pickup latitude&gt;, &lt;pickup longitude&gt;.</p>
</li>

                    </ul>

                </div>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">To add another expression, click the <span class="ph uicontrol">Add</span> icon and enter
                    the following information to generate a trip revenue with no taxes or
                    tolls:</span>
                <div class="itemgroup info">
                    <ul class="ul" id="task_rlk_tdq_ps__ul_xzs_lcn_qs">
                        <li class="li">For the <span class="ph uicontrol">Output Field</span> property, enter
                            "/trip_revenue".</li>

                        <li class="li">For the <span class="ph uicontrol">Expression</span> property, enter the following
                            expression:
                            <pre class="pre codeblock">${record:value('/total_amount') - record:value('/tip_amount')}</pre>
</li>

                    </ul>

                </div>
            </li>
</ol>

        <div class="section result">
            <p class="p">Here's the Expression Evaluator in the extended pipeline:</p>
 <p class="p">
                <img class="image" id="task_rlk_tdq_ps__image_w4n_hpy_ps" src="../Graphics/Tutorial-Expression2.png" height="303" width="813"></img></p>

        </div>

    </div>

</div>
<div class="topic concept nested1" id="concept_u4h_mwf_qs">
 <h2 class="title topictitle2">Preview and Edit the Pipeline</h2>

 
 <div class="body conbody"><p class="shortdesc">Except for the Elasticsearch destination, the extended tutorial is complete. Let's use
  data preview to see how stages transform data. We'll also make some configuration changes and edit
  preview data for testing. </p>

  <p class="p">To preview the pipeline, click the preview icon: <img class="image" id="concept_u4h_mwf_qs__image_iqz_1hg_qs" src="../Graphics/icon-ConfigDataPreview.png" height="15" width="20"></img></p>

  <div class="p">You can explore how each stage transforms data by selecting the stage and reviewing the input
   and output records in the Preview panel. Listed here are some details to note:<dl class="dl">
    
     <dt class="dt dlterm">Field Masker</dt>

     <dd class="dd">To see how the Field Masker masks credit card numbers: <ol class="ol" id="concept_u4h_mwf_qs__ol_ht2_5lg_qs">
       <li class="li">Select the Field Masker in the canvas, and then expand the first input and output
        record.</li>

       <li class="li">Scroll down and note that index 20 is highlighted, indicating a change.</li>

       <li class="li"> Expand index 20 for the input and output data. Notice how all digits except the last 4
        are masked. </li>

      </ol>
</dd>

     <dd class="dd">Say we want to change the mask type to mask the whole credit card number. To review the
      stage property that made this happen and try a different option, complete the following
       steps:<ol class="ol" id="concept_u4h_mwf_qs__ol_vvw_wlg_qs">
       <li class="li">Scroll up and select the <span class="ph uicontrol">Stage Configuration</span> icon: <img class="image" id="concept_u4h_mwf_qs__image_xnl_lmg_qs" src="../Graphics/icon_PrevStageConfig.png" height="16" width="18"></img></li>

       <li class="li">Click the <span class="ph uicontrol">Mask</span> tab.</li>

       <li class="li">Change the <span class="ph uicontrol">Mask Type</span> to <span class="ph uicontrol">Variable Length</span> to
        mask all numbers while showing how many numbers there are in the data. </li>

       <li class="li">To view the data with this change, click the <span class="ph uicontrol">Refresh Preview</span> icon.
         </li>

       <li class="li">In the canvas, select the Field Masker processor and if the Preview panel displays the
        stage configuration, select the <span class="ph uicontrol">Records</span> tab to view the preview
        records. </li>

       <li class="li"> Expand an output record, expand index 20, and notice how the entire number is now
        masked. </li>

      </ol>
</dd>

    
    
     <dt class="dt dlterm">Second Jython Evaluator</dt>

     <dd class="dd">Next, let's look at the second Jython Evaluator in the pipeline. This stage flattens the
      delimited data, but let's see what that looks like:<ul class="ul" id="concept_u4h_mwf_qs__ul_qvt_lmm_qs">
       <li class="li">Select the second Jython Evaluator and expand the first input and output record.
         <p class="p">Notice how the input record is a list of maps and the output record has been flattened
         to the following structure: &lt;field name&gt;: &lt;value&gt;. Isn't that great? </p>
</li>

      </ul>
</dd>

    
    
     <dt class="dt dlterm">Field Converter</dt>

     <dd class="dd">Now let's look at the Field Converter. <ol class="ol" id="concept_u4h_mwf_qs__ol_ajx_pmm_qs">
       <li class="li">To move the focus to the Field Converter, instead of selecting the stage in the pipeline,
        you can click the <span class="ph uicontrol">Next Stage</span> icon.<p class="p">You might notice a red message
         that indicates the first record has an unparsable date - it shows that the date data
         includes invalid characters at the end. </p>
<p class="p">So what happens to this bad record? It
         depends on how the stage is configured. We used the default configuration, but let's see
         what that is:</p>
</li>

       <li class="li">Click the Stage Configuration icon. Notice the <span class="ph uicontrol">On Record Error</span>
                property is set to <span class="ph uicontrol">Send to Error</span>. <p class="p">This means error records
                  are sent to the pipeline for error handling. And you might recall we configured
                  the pipeline to write all error records to file. So with this configuration, the
                  error record will be dropped from the pipeline and written to file. </p>
<p class="p">You can
                  configure this property to stop the pipeline on encountering an error record or to
                  discard error records.</p>
</li>

       <li class="li">To see how it looks when you discard errors, set <span class="ph uicontrol">On Record Error</span>
        to <span class="ph uicontrol">Discard</span>. And then, click the <span class="ph uicontrol">Refresh
         Preview</span> icon.</li>

       <li class="li">On the canvas, select the <span class="ph uicontrol">Field Converter </span>stage, and then click
        the <span class="ph uicontrol">Records</span> icon in the Preview panel. Notice the first record is
        discarded without notice of the error that occurred. </li>

       <li class="li">We prefer to keep error records, so go back to the Stage Configuration tab and change
         <span class="ph uicontrol">On Record Error</span> back to <span class="ph uicontrol">Send to Error</span>.</li>

      </ol>
</dd>

    
    
     <dt class="dt dlterm">Second Expression Evaluator</dt>

     <dd class="dd">The second Expression Evaluator manipulates data. Let's take a look and try editing some
              data.<ol class="ol" id="concept_u4h_mwf_qs__ol_u54_mx3_rs">
              <li class="li">Click the <span class="ph uicontrol">Next Stage</span> icon or select the Expression
                Evaluator.</li>

              <li class="li">If necessary, expand a couple input and output records. <p class="p">Notice the fields
                  created by the stage, pickup_location and trip_location, are highlighted in
                  green.</p>
<p class="p">Though it isn't necessary for these calculations, let's see how you
                  can edit preview data to test stage configuration.</p>
</li>

              <li class="li">In the first input record - in the Input Data column, click on the Pickup Latitude
                  data,<span class="ph uicontrol"> 40.730068</span>, add a negative sign before the data, and
                hit <span class="ph uicontrol">Enter</span> or click outside the data.<p class="p">The edited input data
                  becomes red to indicate a change. </p>
</li>

              <li class="li">To test the change, click the <span class="ph uicontrol">Run Preview with Changes</span>
                icon: <img class="image" id="concept_u4h_mwf_qs__image_awt_jbj_rs" src="../Graphics/icon_PreviewRerun.png" height="13" width="17"></img><p class="p">The <span class="ph">Data
                  Collector</span> runs the preview with the change. Notice the corresponding output record now
                  has -40.730068 for both pickup_latitude and pickup_location. </p>
<p class="p"><img class="image" id="concept_u4h_mwf_qs__image_bgm_cfj_rs" src="../Graphics/Tutorial-PreviewEditData.png" height="388" width="692"></img></p>
<p class="p">You can see how this functionality might come in handy when you want to
                  test some cases that didn't come up in the preview data. </p>
</li>

              <li class="li">To revert that change, click the <span class="ph uicontrol">Revert Data Changes</span> icon.
                This icon does not revert configuration changes. </li>

            </ol>
</dd>

    
   </dl>
</div>

 </div>

</div>
<div class="topic task nested1" id="task_lh2_yhy_ps">
    <h2 class="title topictitle2">Write to Elasticsearch</h2>

    
    <div class="body taskbody"><p class="shortdesc">We'll use the Elasticsearch destination to write to an Elasticsearch cluster. You
        write data to Elasticsearch as individual documents with an index and mapping fields defined
        to help return the documents on a search.</p>

        <div class="section context">
            <p class="p">If you have an Elasticsearch cluster, you can configure the destination to write to
                your instance. For the tutorial, we'll use the default placeholder properties for
                required fields so we can run data preview instead of running the pipeline. </p>

        </div>

        <ol class="ol steps" id="task_lh2_yhy_ps__steps_nqd_p3y_ps"><li class="li step stepexpand">
                <span class="ph cmd">Add an <span class="ph uicontrol">Elasticsearch</span> destination to the canvas and
                    connect it to the <span class="ph uicontrol">Expression Evaluator</span>.</span>
            </li>
<li class="li step stepexpand">
                <span class="ph cmd">On the <span class="keyword wintitle">Elasticsearch</span> tab, enter the following properties
                    and use defaults for the rest:</span>
                <div class="itemgroup info">
                    
<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" id="task_lh2_yhy_ps__table_mdq_p3z_ps" class="table" frame="border" border="1" rules="all">
                            
                            
                            <thead class="thead" align="left">
                                <tr class="row">
                                    <th class="entry" valign="top" id="d48979e703">Elasticsearch Property</th>

                                    <th class="entry" valign="top" id="d48979e706">Value</th>

                                </tr>

                            </thead>

                            <tbody class="tbody">
                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e703 ">Index</td>

                                    <td class="entry" valign="top" headers="d48979e706 ">taxi_rides</td>

                                </tr>

                                <tr class="row">
                                    <td class="entry" valign="top" headers="d48979e703 ">Type</td>

                                    <td class="entry" valign="top" headers="d48979e706 ">taxi_ride</td>

                                </tr>

                            </tbody>

                        </table>
</div>

                </div>
            </li>
</ol>

        <div class="section result">Here's the full pipeline:<p class="p"><img class="image" id="task_lh2_yhy_ps__image_xds_wry_ps" src="../Graphics/Tutorial-Elasticsearch.png" height="364" width="807"></img></p>
</div>

    </div>

</div>
<div class="topic task nested1" id="task_fsb_1my_ps">
    <h2 class="title topictitle2">Run or Preview the Pipeline</h2>

    
    <div class="body taskbody"><p class="shortdesc">You can run the pipeline if you configured the Elasticsearch destination to write to
        your Elasticsearch cluster. Or, if you don't use Elasticsearch, or if you want a close look
        at how the pipeline works, use data preview.</p>

        <div class="section context"></div>

    </div>

</div>
</div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="../Tutorial/Tutorial-title.html" title="Data Collector Tutorial"><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Data Collector Tutorial</span></a></span>  </div><div class="footer"><div> </div><!-- Â© <a href="http://creativecommons.org/licenses/by-nc/4.0/legalcode">CC BY-NC 4.0.</a> StreamSets, 2015. --></div>
</body>
</html>